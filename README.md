# GENERATE_RANDOM_IFT_USER_12M_4Q_BASE

## Формулировка задачи и техническое задание

Проект представляет собой генератор случайных пользователей IFT (If-Then) с параметрами 12M (12 месяцев) и 4Q (4 квартала) и их показателей с помесячной разбивкой.

**Техническое задание:**
- Создание базовой структуры проекта на Python
- Настройка системы логирования с уровнями INFO и DEBUG
- Загрузка и обработка списка организационных единиц из CSV файла
- Фильтрация данных по заданным критериям
- Экспорт обработанных данных в Excel с настройками форматирования
- Генерация случайных пользователей (клиентские менеджеры КСБ и менеджеры нефинансовых сервисов)
- Генерация показателей с помесячной разбивкой

## Подробное описание решения

Проект организован согласно стандартным правилам разработки:
- Весь код проекта находится в одном файле `src/main.py`, разделенный на модули
- **Проект использует библиотеки из стандартной установки Anaconda** (pandas, openpyxl)
- Работает на Python 3.9+ с Anaconda 3.9 (pandas и openpyxl обычно уже установлены)
- Не требует установки дополнительных пакетов, если используется стандартная установка Anaconda
- Тестовые файлы хранятся в `src/Tests`
- Дополнительная документация в папке `Docs`
- Входные данные (CSV файлы) размещаются в папке `IN`
- Выходные данные (Excel файлы) сохраняются в папке `OUT`
- Логи сохраняются в папку `log` с форматом: `Уровень_(тема)_годмесяцдень_часминута.log`
- Сообщения уровня INFO выводятся в консоль для отслеживания процесса выполнения
- Все параметры конфигурации задаются в начале файла `main.py` в разделе "ПАРАМЕТРЫ КОНФИГУРАЦИИ"

**Текущий функционал:**
- Загрузка организационных единиц из CSV файла
- Фильтрация данных по кодам ТБ и ГОСБ
- Экспорт в Excel с настройками форматирования (закрепленная первая строка, автофильтр, автоматическая ширина колонок)
- Вывод сообщений уровня INFO в консоль для мониторинга процесса выполнения

## Структура каталогов

```
GENERATE_RANDOM_IFT_USER_12M_4Q_BASE/
├── src/                    # Основной исходный код
│   ├── main.py            # Весь код проекта (модули внутри файла)
│   └── Tests/             # Тестовые файлы
├── IN/                     # Входные данные (CSV файлы)
├── OUT/                    # Выходные данные (Excel файлы)
├── Docs/                   # Дополнительная документация
├── log/                    # Файлы логов
├── .gitignore              # Игнорируемые файлы
├── requirements.txt        # Зависимости проекта
└── README.md              # Основная документация
```

## Список переменных и функций

### Параметры конфигурации

Все параметры задаются в начале файла `src/main.py` в разделе "ПАРАМЕТРЫ КОНФИГУРАЦИИ":

**Общие параметры:**
- `LOG_DIR` - Директория для хранения логов (по умолчанию: `"log"`)
- `LOG_LEVEL` - Уровень логирования: `"INFO"` или `"DEBUG"` (по умолчанию: `"DEBUG"`)
- `OUTPUT_DIR` - Директория для выходных Excel файлов (по умолчанию: `"OUT"`)
- `OUTPUT_FILE_BASE` - Базовое имя выходного Excel файла (по умолчанию: `"result_base"`)

**Конфигурация загрузчиков данных (`LOADER_CONFIG`):**

Структура конфигурации для каждого загрузчика (соответствует отдельному листу в Excel):

```python
LOADER_CONFIG = {
    'ORG': {
        'input_file': "IN/SVD_KB_DM_GAMIFICATION_ORG_UNIT_V20 - 2025.08.28.csv",
        'sheet_name': 'ORG',
        'max_column_width': 100,
        'filters': {
            'tb_code_exclude': {'99', '100', '101', '102'},
            'gosb_code_exclude': {'0', '9038', '9040'}
        },
        'column_mapping': {
            'TB_CODE': 'Код ТБ',
            'TB_FULL_NAME': 'Полное ТБ',
            # ... и т.д.
        }
    }
    # В будущем здесь можно добавить другие загрузчики:
    # 'USERS': {...},
    # 'METRICS': {...}
}
```

**Параметры для каждого загрузчика:**
- `input_file` - Путь к входному CSV файлу
- `sheet_name` - Имя листа в Excel
- `max_column_width` - Максимальная ширина колонки (по умолчанию: `100`)
- `filters` - Словарь фильтров для исключения строк:
  - `tb_code_exclude` - Множество кодов ТБ для исключения
  - `gosb_code_exclude` - Множество кодов ГОСБ для исключения
- `column_mapping` - Словарь маппинга колонок: исходное_имя -> результирующее_имя

### Классы

#### `ProjectLogger`

Класс для управления логированием проекта.

**Особенности:**
- Создает логи с форматом: `Уровень_(тема)_годмесяцдень_часминута.log`
- DEBUG логи имеют формат: `дата время - [уровень] - сообщение [class: <имя класса> | def: <имя функции>]`
- INFO логи выводятся в консоль и сохраняются в файл
- DEBUG логи сохраняются только в файл

**Методы:**
- `_setup_file_handlers()` - Настройка файловых обработчиков для DEBUG и INFO логов
- `_setup_console_handler()` - Настройка консольного обработчика для вывода INFO сообщений
- `get_logger()` - Получение настроенного логгера

**Параметры инициализации:**
- `log_dir` (str): Директория для хранения логов (по умолчанию: `"log"`)
- `log_level` (str): Уровень логирования (по умолчанию: `"DEBUG"`)

#### `OrgUnitsLoader`

Класс для загрузки и обработки организационных единиц из CSV файла.

**Параметры инициализации:**
- `config` (Dict): Словарь конфигурации из `LOADER_CONFIG` для данного загрузчика
- `output_file_base` (str): Базовое имя выходного Excel файла
- `output_dir` (str): Директория для выходных файлов
- `logger` (Optional[logging.Logger]): Логгер для записи событий

**Методы:**
- `load_csv()` - Загружает данные из CSV файла
- `filter_data(df)` - Фильтрует данные по заданным критериям:
  - Исключает строки где `TB_CODE` в (99, 100, 101, 102)
  - Исключает строки где `GOSB_CODE` в (0, 9038, 9040)
- `select_columns(df)` - Выбирает и переименовывает необходимые колонки:
  - `TB_CODE` → `Код ТБ`
  - `TB_FULL_NAME` → `Полное ТБ`
  - `TB_SHORT_NAME` → `Короткое ТБ`
  - `GOSB_CODE` → `Код ГОСБ`
  - `GOSB_NAME` → `Полное ГОСБ`
  - `GOSB_SHORT_NAME` → `Короткое ГОСБ`
  - `ORG_UNIT_CODE` → `Код подразделения`
- `save_to_excel(df)` - Сохраняет данные в Excel с настройками:
  - Лист: `ORG`
  - Первая строка закреплена
  - Автофильтр включен
  - Ширина колонок по содержимому (максимум 100)
- `process()` - Выполняет полный цикл обработки

**Пример использования:**
```python
# Все классы и функции находятся в src/main.py
from src.main import OrgUnitsLoader, LOADER_CONFIG, get_logger

logger = get_logger()
loader = OrgUnitsLoader(
    config=LOADER_CONFIG['ORG'],
    output_file_base="result_base",
    output_dir="OUT",
    logger=logger
)
output_file = loader.process()
```

### Функции

#### `load_org_units(input_file, output_file_base, logger)`

Функция-обертка для загрузки и обработки организационных единиц.

**Параметры:**
- `config` (Dict): Словарь конфигурации из `LOADER_CONFIG` для загрузчика
- `output_file_base` (str): Базовое имя выходного Excel файла (по умолчанию: `"result_base"`)
- `output_dir` (str): Директория для выходных файлов (по умолчанию: `"OUT"`)
- `logger` (Optional[logging.Logger]): Логгер для записи событий

**Возвращает:**
- `str`: Путь к созданному Excel файлу

**Пример использования:**
```python
# Все классы и функции находятся в src/main.py
from src.main import load_org_units, LOADER_CONFIG, get_logger

logger = get_logger()
output = load_org_units(
    config=LOADER_CONFIG['ORG'],
    output_file_base="result_base",
    output_dir="OUT",
    logger=logger
)
print(f"Создан файл: {output}")
```

**Запуск приложения:**
```bash
# Запуск из корня проекта
python src/main.py

# Или с указанием PYTHONPATH
PYTHONPATH=/path/to/project python src/main.py
```

#### `get_logger(log_dir, log_level)`

Функция для получения настроенного логгера проекта.

**Параметры:**
- `log_dir` (Optional[str]): Директория для логов
- `log_level` (Optional[str]): Уровень логирования (`INFO` или `DEBUG`)

**Возвращает:**
- `logging.Logger`: Настроенный объект логгера

#### `main()`

Главная функция приложения. Инициализирует логгер и выполняет загрузку данных для всех загрузчиков из `LOADER_CONFIG`.

## История версий

### Версия 0.7.0 (2025-11-01)

**Решенные проблемы:**
- Добавлен вывод сообщений уровня INFO в консоль
- Улучшена видимость процесса выполнения программы
- Упрощен мониторинг работы приложения без необходимости открывать файлы логов

**Выполненные задачи:**
- Добавлен консольный обработчик (StreamHandler) для вывода сообщений уровня INFO
- Создан метод `_setup_console_handler()` для настройки консольного вывода
- Сообщения уровня INFO теперь отображаются в консоли в реальном времени
- Обновлена документация в README.md

**Технические детали:**
- Консольный обработчик использует тот же форматтер, что и файловые логи INFO
- Формат вывода: `дата время - [INFO] - сообщение`
- DEBUG сообщения остаются только в файлах логов
- Консольный вывод помогает отслеживать прогресс выполнения программы

### Версия 0.6.0 (2025-11-01)

**Решенные проблемы:**
- Возвращено использование pandas и openpyxl из стандартной установки Anaconda
- Упрощен код за счет использования готовых библиотек вместо ручного создания XML
- Улучшена производительность и читаемость кода

**Выполненные задачи:**
- Возвращен pandas для работы с CSV и DataFrame
- Возвращен openpyxl для создания и форматирования Excel файлов
- Удалены методы ручного создания XML структуры Excel
- Упрощен код загрузки, фильтрации и сохранения данных
- Обновлен requirements.txt с указанием библиотек из Anaconda
- Обновлена документация в README.md

**Технические детали:**
- CSV файлы читаются через pandas.read_csv()
- Excel файлы создаются через pandas.ExcelWriter с engine='openpyxl'
- Форматирование Excel выполняется через openpyxl (закрепленная строка, автофильтр, ширина колонок, жирный шрифт)
- Проект использует библиотеки, которые обычно уже установлены в Anaconda

### Версия 0.5.0 (2025-11-01)

**Решенные проблемы:**
- Объединены все параметры загрузки ORG в единую структуру конфигурации `LOADER_CONFIG`
- Улучшена наглядность и организация параметров конфигурации
- Подготовлена структура для добавления новых загрузчиков данных в будущем

**Выполненные задачи:**
- Создана структура `LOADER_CONFIG` для централизованного хранения параметров загрузчиков
- Все параметры ORG (входной файл, фильтры, маппинг колонок, настройки Excel) объединены в один словарь
- Обновлен класс `OrgUnitsLoader` для работы с новой структурой конфигурации
- Обновлена функция `main()` для обработки всех загрузчиков из `LOADER_CONFIG`
- Добавлены комментарии-примеры для будущих загрузчиков (USERS, METRICS)
- Обновлена документация в README.md

**Технические детали:**
- Структура `LOADER_CONFIG` позволяет легко добавлять новые загрузчики данных
- Каждый загрузчик имеет свою конфигурацию: входной файл, фильтры, маппинг колонок, настройки Excel
- Функция `main()` автоматически обрабатывает все загрузчики из конфигурации
- Параметры организованы в иерархическую структуру для лучшей читаемости

### Версия 0.6.0 (2025-11-01)

**Решенные проблемы:**
- Возвращено использование pandas и openpyxl из стандартной установки Anaconda
- Упрощен код за счет использования готовых библиотек вместо ручного создания XML
- Улучшена производительность и читаемость кода

**Выполненные задачи:**
- Возвращен pandas для работы с CSV и DataFrame
- Возвращен openpyxl для создания и форматирования Excel файлов
- Удалены методы ручного создания XML структуры Excel
- Упрощен код загрузки, фильтрации и сохранения данных
- Обновлен requirements.txt с указанием библиотек из Anaconda
- Обновлена документация в README.md

**Технические детали:**
- CSV файлы читаются через pandas.read_csv()
- Excel файлы создаются через pandas.ExcelWriter с engine='openpyxl'
- Форматирование Excel выполняется через openpyxl (закрепленная строка, автофильтр, ширина колонок, жирный шрифт)
- Проект использует библиотеки, которые обычно уже установлены в Anaconda

### Версия 0.4.0 (2025-11-01)

**Решенные проблемы:**
- Переписан код для использования только стандартной библиотеки Python
- Удалены зависимости от pandas и openpyxl
- Проект теперь работает на Python 3.9+ (включая Anaconda 3.9) без дополнительных установок
- Реализовано создание Excel файлов через zipfile и xml.etree.ElementTree

**Выполненные задачи:**
- Заменен pandas на стандартный модуль csv для чтения CSV файлов
- Заменен openpyxl на создание .xlsx файлов через zipfile и XML (формат Office Open XML)
- Реализованы все функции форматирования Excel (закрепленная строка, автофильтр, ширина колонок, жирный шрифт)
- Обновлен requirements.txt - удалены все внешние зависимости
- Обновлена документация в README.md

**Технические детали:**
- CSV файлы читаются через стандартный модуль `csv`
- Excel файлы создаются как ZIP архивы с XML файлами внутри (формат Office Open XML)
- Все функции форматирования реализованы через XML структуру
- Проект полностью автономен и не требует установки дополнительных пакетов

### Версия 0.3.0 (2025-11-01)

**Решенные проблемы:**
- Объединен весь код проекта в один файл `main.py`
- Все параметры конфигурации перенесены в начало файла
- Удалены отдельные модули и файлы конфигурации `.env`
- Упрощена структура проекта

**Выполненные задачи:**
- Объединены модули логирования и загрузки организационных единиц в `main.py`
- Все параметры вынесены в раздел "ПАРАМЕТРЫ КОНФИГУРАЦИИ" в начале файла
- Удалены файлы `logger.py` и `org_units_loader.py`
- Обновлена документация в README.md

**Технические детали:**
- Весь код проекта находится в `src/main.py`, разделенный на модули:
  - Модуль логирования (класс `ProjectLogger` и функция `get_logger`)
  - Модуль загрузки организационных единиц (класс `OrgUnitsLoader` и функция `load_org_units`)
  - Главная функция `main()`
- Все параметры задаются в начале файла как константы
- Не требуется использование переменных окружения или `.env` файлов

### Версия 0.2.0 (2025-11-01)

**Решенные проблемы:**
- Реализована загрузка организационных единиц из CSV файла
- Добавлена фильтрация данных по кодам ТБ и ГОСБ
- Реализован экспорт в Excel с настройками форматирования
- Исправлен формат таймштампа в именах файлов логов (добавлены минуты)
- Добавлена обработка ошибок при загрузке и обработке данных

**Выполненные задачи:**
- Создан модуль `org_units_loader.py` для загрузки и обработки организационных единиц
- Обновлен `main.py` для вызова функции загрузки
- Добавлены зависимости: `pandas` и `openpyxl`
- Настроена фильтрация данных по заданным критериям
- Реализовано форматирование Excel файлов (закрепленная строка, автофильтр, ширина колонок)
- Обновлена документация в README.md

**Технические детали:**
- CSV файл загружается с разделителем `;` и кодировкой UTF-8
- Фильтрация исключает строки с `TB_CODE` в (99, 100, 101, 102) и `GOSB_CODE` в (0, 9038, 9040)
- Выходной Excel файл содержит только выбранные колонки с переименованными заголовками
- Имя выходного файла формируется как `{output_file_base}_YYYYMMDD_HHMM.xlsx`

### Версия 0.1.0 (2025-11-01)

**Решенные проблемы:**
- Создана базовая структура проекта
- Настроена система логирования с уровнями INFO и DEBUG
- Подготовлена инфраструктура для разработки
- Настроен .gitignore для исключения временных файлов и секретов
- Создан шаблон .env.example

**Выполненные задачи:**
- Инициализация структуры каталогов
- Создание базового модуля логирования
- Настройка виртуального окружения
- Подготовка файлов конфигурации

